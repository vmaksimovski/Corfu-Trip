<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025 Summer Vacation</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.12.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.12.0/mapbox-gl.css' rel='stylesheet' />
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <script src="https://unpkg.com/three@0.106.2/build/three.min.js"></script>
    <script src="https://unpkg.com/threebox-plugin@2.2.7/dist/threebox.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        #sidebar {
            width: 350px;
            background: #2c3e50;
            color: white;
            padding: 20px;
            overflow: hidden;
            box-shadow: 2px 0 10px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
        }

        #sidebar h1 {
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            flex-shrink: 0;
        }

        #destinations {
            flex: 1;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .destination {
            position: absolute;
            width: 90%;
            background: #34495e;
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid transparent;
            opacity: 0.3;
            transform: scale(0.8);
            top: 110%;
        }

        .destination.previous {
            top: -15%;
            opacity: 0.3;
            transform: scale(0.8);
            filter: grayscale(50%);
        }

        .destination.active {
            top: 50%;
            transform: translateY(-50%) scale(0.9);
            opacity: 1;
            background: #34495e;
            border-color: #3498db;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            height: 60%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .destination.active:hover {
            transform: translateY(-50%) scale(0.92);
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        }
        
        .destination.active .google-maps-hint {
            opacity: 0.7 !important;
            transition: opacity 0.3s ease;
        }
        
        .destination.active:hover .google-maps-hint {
            opacity: 1 !important;
        }
        
        .google-maps-hint:hover {
            text-decoration: underline !important;
            transform: translateY(-1px);
        }
        
        .destination.active[data-country="Greece"] {
            border-color: #0066cc;
        }
        
        .destination.active[data-country="Albania"] {
            border-color: #e41e20;
        }
        
        .destination.active[data-country="Macedonia"] {
            border-color: #FFD700;
        }

        .destination.next {
            top: 85%;
            opacity: 0.3;
            transform: scale(0.8);
            filter: grayscale(50%);
        }

        .destination.hidden {
            opacity: 0;
            transform: scale(0.7);
            pointer-events: none;
            top: 110%;
        }

        .destination-header {
            flex-shrink: 0;
        }

        .destination h3 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #3498db;
        }

        .destination .country {
            font-size: 16px;
            opacity: 0.8;
            margin-bottom: 20px;
        }

        .destination .description {
            font-size: 20px;
            line-height: 1.6;
            flex: 1;
            overflow-y: auto;
            margin: 20px 0;
        }

        .destination .navigation {
            display: none;
            margin-top: 20px;
        }

        .destination.active .navigation {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }

        .nav-info {
            font-size: 14px;
            opacity: 0.7;
            margin-bottom: 30px;
            text-align: center;
        }

        .nav-buttons {
            display: flex;
            justify-content: space-between;
            width: 100%;
            gap: 20px;
        }

        .nav-button {
            background: #3498db;
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .nav-button:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        }

        .nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .nav-button:disabled:hover {
            background: #3498db;
            transform: none;
            box-shadow: none;
        }

        #map {
            flex: 1;
            position: relative;
        }

        .mapboxgl-popup {
            max-width: 200px;
        }

        .mapboxgl-popup-content {
            text-align: center;
            font-family: 'Arial', sans-serif;
            background-color: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(5px);
        }

        .mapboxgl-popup-tip {
            opacity: 0.4;
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <h1>Corfu & Sarandë Trip Itinerary</h1>
        <div id="destinations"></div>
    </div>
    <div id="map"></div>

    <script>
        // Mapbox access token
        mapboxgl.accessToken = 'pk.eyJ1Ijoidm1ha3NpbW92c2tpIiwiYSI6ImNtYmNwZzlkNDExNW0ybm9sODd4eXVzZTEifQ.uLOwTgP6Z_3OvlOrGKJt3Q';

        fetch('./data/trip_coordinates.json')
            .then(response => response.json())
            .then(data => {
                initializeMap(data.activities);
            })
            .catch(error => {
                console.error('Error loading trip data:', error);
                // Initialize with empty array if file can't be loaded
                initializeMap([]);
            });

        // Main initialization function
        function initializeMap(tripActivities) {
            // Convert trip activities to destinations format
            const destinations = tripActivities.map((activity, index) => {
                const date = new Date(activity.day);
                const dayOfTrip = Math.floor((date - new Date('2025-06-05')) / (1000 * 60 * 60 * 24)) + 1;
                // More accurate country detection based on actual locations
                // Albania locations include: Sarandë, Butrint, Ksamil, Lëkurës Castle
                const albaniaLocations = [
                    "Arrive Sarandë Ferry Terminal",
                    "Te Bequa",
                    "Sarandë Waterfront Promenade",
                    "Lëkurës Castle Sunset",
                    "Dinner at Natyra Restaurant",
                    "Natyra Restaurant",
                    "Butrint UNESCO World Heritage Site",
                    "Paradise at Ksamil Beach",
                    "Haxhi Restaurant",
                    "Rei dos Mares Boat Tour",
                    "Final Dinner at Meat House",
                    "Meat House",
                    "Evening Ferry to Corfu"
                ];
                const country = activity.title === "Shtip" ? "Macedonia" : 
                               albaniaLocations.includes(activity.title) ? "Albania" : "Greece";
                
                return {
                    name: activity.title,
                    country: country,
                    coordinates: [activity.long, activity.lat],
                    description: activity.description,
                    day: `Day ${dayOfTrip}`,
                    time: activity.time,
                    date: activity.day
                };
            });

            // Initialize map
            const map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/satellite-v9',
                center: [19.95, 39.75], // Center between Corfu and Sarandë
                zoom: 9.5,
                pitch: 45,
                bearing: 0,
                antialias: true
            });

            // Make map accessible globally for testing
            window.map = map;

            // Initialize Threebox
            let tb;
            
            map.on('load', function () {
                // Add 3D terrain
                map.addSource('mapbox-dem', {
                    'type': 'raster-dem',
                    'url': 'mapbox://mapbox.mapbox-terrain-dem-v1',
                    'tileSize': 512,
                    'maxzoom': 14
                });
                
                map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1.5 });
                
                // Add sky layer
                map.addLayer({
                    'id': 'sky',
                    'type': 'sky',
                    'paint': {
                        'sky-type': 'atmosphere',
                        'sky-atmosphere-sun': [0.0, 0.0],
                        'sky-atmosphere-sun-intensity': 15
                    }
                });

                // Initialize Threebox
                tb = window.Threebox(
                    map,
                    map.getCanvas().getContext('webgl'),
                    {
                        defaultLights: true
                    }
                );

                // Add 3D markers for each destination
                map.addLayer({
                    id: 'custom-3d-layer',
                    type: 'custom',
                    renderingMode: '3d',
                    onAdd: function (map, mbxContext) {
                        destinations.forEach((dest, index) => {
                            // Create 3D marker
                            const scale = 0.5;
                            const geometry = new THREE.ConeGeometry(5000, 15000, 8);
                            const markerColor = dest.country === 'Greece' ? 0x0066cc : 
                                              dest.country === 'Macedonia' ? 0xFFD700 : 0xe41e20;
                            const emissiveColor = dest.country === 'Greece' ? 0x004499 : 
                                                dest.country === 'Macedonia' ? 0xFFA500 : 0xcc1a1c;
                            const material = new THREE.MeshPhongMaterial({ 
                                color: markerColor,
                                emissive: emissiveColor,
                                emissiveIntensity: 0.3
                            });
                            
                            const cone = new THREE.Mesh(geometry, material);
                            cone.rotation.x = Math.PI;
                            
                            const marker = tb.Object3D({
                                obj: cone,
                                units: 'meters',
                                anchor: 'bottom'
                            });
                            
                            marker.setCoords([dest.coordinates[0], dest.coordinates[1]]);
                            tb.add(marker);
                        });
                    },
                    
                    render: function (gl, matrix) {
                        tb.update();
                    }
                });
            });

            // Current active destination index (-1 means showing start screen)
            let currentDestinationIndex = -1;

            // Create destination list in sidebar
            function createDestinationList() {
                const container = document.getElementById('destinations');
                
                // Add Start button first
                const startDiv = document.createElement('div');
                startDiv.className = 'destination start-screen active';
                startDiv.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center;">
                        <h2 style="font-size: 32px; margin-bottom: 20px; color: #3498db;">Ready to explore?</h2>
                        <p style="font-size: 18px; margin-bottom: 30px; opacity: 0.8;">Your Mediterranean adventure awaits</p>
                        <button class="nav-button" onclick="startJourney()" style="font-size: 20px; padding: 16px 40px;">Start Journey</button>
                    </div>
                `;
                container.appendChild(startDiv);

                destinations.forEach((dest, index) => {
                    const div = document.createElement('div');
                    div.className = 'destination';
                    div.dataset.index = index;
                    div.dataset.country = dest.country;
                    
                    div.innerHTML = `
                        <div class="destination-header">
                            <h3>${dest.name}</h3>
                            <p class="country">${dest.country} • ${dest.day} • ${dest.time}</p>
                            <a class="google-maps-hint" href="https://www.google.com/maps/place/${dest.coordinates[1]},+${dest.coordinates[0]}" target="_blank" style="font-size: 12px; opacity: 0; margin-top: 8px; color: #3498db; text-decoration: none; display: inline-block;">📍 Click to open in Google Maps</a>
                        </div>
                        <div class="description">${dest.description}</div>
                        <div class="navigation">
                            <div class="nav-info">${index + 1} of ${destinations.length}</div>
                            <div class="nav-buttons">
                                <button class="nav-button" onclick="navigateDestination(-1)" ${index === 0 ? 'disabled' : ''}>Previous</button>
                                <button class="nav-button" onclick="navigateDestination(1)" ${index === destinations.length - 1 ? 'disabled' : ''}>Next</button>
                            </div>
                        </div>
                    `;
                    
                    div.addEventListener('click', (e) => {
                        // Don't trigger if clicking on navigation buttons or links
                        if (!e.target.classList.contains('nav-button') && !e.target.classList.contains('google-maps-hint') && !div.classList.contains('active')) {
                            setActiveDestination(index);
                        }
                    });
                    container.appendChild(div);
                });
                
                // Set initial active destination
                updateDestinationDisplay();
            }

            // Navigate to previous/next destination
            window.navigateDestination = function(direction) {
                const newIndex = currentDestinationIndex + direction;
                if (newIndex >= 0 && newIndex < destinations.length) {
                    // Close any existing popups
                    const existingPopups = document.querySelectorAll('.mapboxgl-popup');
                    existingPopups.forEach(popup => popup.remove());
                    setActiveDestination(newIndex);
                }
            }

            // Start journey function
            window.startJourney = function() {
                // Close any existing popups
                const existingPopups = document.querySelectorAll('.mapboxgl-popup');
                existingPopups.forEach(popup => popup.remove());
                setActiveDestination(0);
            }

            // Set active destination
            function setActiveDestination(index) {
                currentDestinationIndex = index;
                updateDestinationDisplay();
                if (index >= 0 && index < destinations.length) {
                    flyToDestination(destinations[index]);
                }
            }

            // Calculate bearing between two points
            function calculateBearing(from, to) {
                const lat1 = from[1] * Math.PI / 180;
                const lat2 = to[1] * Math.PI / 180;
                const deltaLon = (to[0] - from[0]) * Math.PI / 180;

                const x = Math.sin(deltaLon) * Math.cos(lat2);
                const y = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(deltaLon);

                const bearing = Math.atan2(x, y);
                return (bearing * 180 / Math.PI + 360) % 360;
            }

            // Update the display of destinations
            function updateDestinationDisplay() {
                const allDestinations = document.querySelectorAll('.destination');
                const startScreen = document.querySelector('.start-screen');
                
                allDestinations.forEach((dest, index) => {
                    dest.classList.remove('active', 'previous', 'next', 'hidden');
                    
                    // Handle start screen
                    if (dest.classList.contains('start-screen')) {
                        if (currentDestinationIndex === -1) {
                            dest.classList.add('active');
                        } else {
                            dest.style.display = 'none';
                        }
                        return;
                    }

                    // Adjust index for regular destinations (account for start screen)
                    const destIndex = parseInt(dest.dataset.index);

                    if (destIndex === currentDestinationIndex) {
                        dest.classList.add('active');
                        // Update navigation buttons
                        const prevBtn = dest.querySelector('.navigation button:first-child');
                        const nextBtn = dest.querySelector('.navigation button:last-child');
                        if (prevBtn) prevBtn.disabled = destIndex === 0;
                        if (nextBtn) nextBtn.disabled = destIndex === destinations.length - 1;
                    } else if (destIndex === currentDestinationIndex - 1) {
                        dest.classList.add('previous');
                    } else if (destIndex === currentDestinationIndex + 1) {
                        dest.classList.add('next');
                    } else {
                        dest.classList.add('hidden');
                    }
                });
            }

            // Fly to destination function
            function flyToDestination(destination) {
                // Calculate bearing to face Corfu center
                const corfuCenter = [19.903323392242235, 39.614520280161535];
                const bearing = calculateBearing(destination.coordinates, corfuCenter);

                map.flyTo({
                    center: destination.coordinates,
                    zoom: 14,
                    pitch: 60,
                    bearing: bearing,
                    duration: 4000,
                    essential: true
                });

                // Show popup immediately
                new mapboxgl.Popup()
                    .setLngLat(destination.coordinates)
                    .setHTML(`
                        <h3>${destination.name}</h3>
                        <p>${destination.country} • ${destination.day}</p>
                        <p>${destination.time}</p>
                        <p><em>${destination.description}</em></p>
                    `)
                    .addTo(map);
            }

            // Add navigation controls
            map.addControl(new mapboxgl.NavigationControl());
            map.addControl(new mapboxgl.FullscreenControl());

            // Create the destination list immediately
            createDestinationList();

            // Add markers for each destination
            destinations.forEach((dest, index) => {
                const el = document.createElement('div');
                el.style.width = '30px';
                el.style.height = '30px';
                el.style.backgroundColor = dest.country === 'Greece' ? '#0066cc' : 
                                          dest.country === 'Macedonia' ? '#FFD700' : '#e41e20';
                el.style.borderRadius = '50%';
                el.style.border = '3px solid white';
                el.style.cursor = 'pointer';
                el.style.boxShadow = '0 2px 5px rgba(0,0,0,0.3)';

                new mapboxgl.Marker(el)
                    .setLngLat(dest.coordinates)
                    .addTo(map);

                el.addEventListener('click', () => setActiveDestination(index));
            });
        }
    </script>
</body>
</html>